var GameApp=function(){var e,a=$(".app"),t=$(".real-cels"),o=$(".js-cur-score"),r=$(".js-last-cur-score"),n=$(".js-best-score"),s=$(".js-last-best-score"),l=$(".js-undo"),c=$(".js-new-game"),i=$(".new-game-line"),d=$("#undo").html(),m=4,f=0,u=[],v={},h={getRandomInt:function(e,a){return Math.floor(Math.random()*(a-e+1))+e},fourOrTwo:function(){return h.getRandomInt(0,10)>7?4:2},setScore:function(e){f+=e,parseInt(o.html())<f&&(r.html("+"+(f-parseInt(o.html()))).addClass("moved"),o.html(f),setTimeout(function(){r.removeClass("moved"),s.removeClass("moved")},200)),parseInt(n.html())<f&&(s.html("+"+(f-parseInt(n.html()))).addClass("moved"),n.html(f),h.localStorBest(f))},getFreeCells:function(){for(var e=[],a=0,t=0;t<m;t++)for(var o=0;o<m;o++)0==v[t][o]?e.push(""+[t]+[o]):a+=v[t][o];return e},newRandCell:function(){var e=h.getFreeCells(),a=e[h.getRandomInt(0,e.length-1)],o=a.slice(0,1),r=a.slice(1,2),n=h.fourOrTwo();v[o][r]=n,t.append('<div class="cell" data-x="'+o+'" data-y="'+r+'" data-num="'+n+'"></div>');var s={score:f,cells:v};u.push(jQuery.extend(!0,{},s)),h.localStorGame(s),u.length>2&&l.removeClass("disabled")},localStorBest:function(e){if(e)localStorage.setItem("best"+m,e);else{var a=localStorage.getItem("best"+m);a?n.html(a):n.html(0)}},localStorGame:function(e){if(!e){var a=JSON.parse(localStorage.getItem("game"));return!!a&&a}e.size=m,localStorage.setItem("game",JSON.stringify(e))},chPos:function(e,a){t.find('.cell[data-x="'+e.x+'"][data-y="'+e.y+'"]').attr("data-x",a.x).attr("data-y",a.y)},compare:function(e,a){var o=t.find('.cell[data-x="'+e.x+'"][data-y="'+e.y+'"]'),r=t.find('.cell[data-x="'+a.x+'"][data-y="'+a.y+'"]');o.attr("data-x",a.x).attr("data-y",a.y),h.setScore(a.num),setTimeout(function(){r.attr("data-num",a.num).addClass("compare"),setTimeout(function(){r.removeClass("compare")},100),o.remove()},100)},move:function(e){switch(e){case"top":for(var a=0;a<m;a++)for(var t=0;t<m;t++)if(v[a][t])for(var o=t;o>0;)if(v[a][o-1]){if(v[a][o-1]!=v[a][o])break;v[a][o-1]*=2,h.compare({x:a,y:o},{x:a,y:o-1,num:v[a][o-1]}),v[a][o]=0}else v[a][o-1]=v[a][o],v[a][o]=0,h.chPos({x:a,y:o},{x:a,y:o-1}),o--;break;case"down":for(var a=0;a<m;a++)for(var t=m-1;t>=0;t--)if(v[a][t])for(var o=t;o<m-1;)if(v[a][o+1]){if(v[a][o+1]!=v[a][o])break;v[a][o+1]*=2,h.compare({x:a,y:o},{x:a,y:o+1,num:v[a][o+1]}),v[a][o]=0}else v[a][o+1]=v[a][o],v[a][o]=0,h.chPos({x:a,y:o},{x:a,y:o+1}),o++;break;case"left":for(var a=0;a<m;a++)for(var t=0;t<m;t++)if(v[a][t])for(var o=a;o>0;)if(v[o-1][t]){if(v[o-1][t]!=v[o][t])break;v[o-1][t]*=2,h.compare({x:o,y:t},{x:o-1,y:t,num:v[o-1][t]}),v[o][t]=0}else v[o-1][t]=v[o][t],v[o][t]=0,h.chPos({x:o,y:t},{x:o-1,y:t}),o--;break;case"right":for(var a=m-1;a>=0;a--)for(var t=0;t<m;t++)if(v[a][t])for(var o=a;o<m-1;)if(v[o+1][t]){if(v[o+1][t]!=v[o][t])break;v[o+1][t]*=2,h.compare({x:o,y:t},{x:o+1,y:t,num:v[o+1][t]}),v[o][t]=0}else v[o+1][t]=v[o][t],v[o][t]=0,h.chPos({x:o,y:t},{x:o+1,y:t}),o++}h.afterMove()},afterMove:function(){var e=u[u.length-1].cells,a=JSON.stringify(e)===JSON.stringify(v);a||h.newRandCell()},renderNewGrid:function(){m=parseInt(a.attr("data-size")),l.addClass("disabled"),t.html(""),r.removeClass("moved"),s.removeClass("moved"),o.html(0),r.removeClass("moved"),s.removeClass("moved"),u=[],f=0,v={};for(var e=0;e<m;e++){v[e]={};for(var n=0;n<m;n++)v[e][n]=0}h.newRandCell(),h.newRandCell(),h.localStorBest()},compileFromHandle:function(){t.html(e(v))},undo:function(){l.hasClass("disabled")||(u.splice(u.length-1,1),v=jQuery.extend(!0,{},u[u.length-1].cells),f=u[u.length-1].score,o.html(u[u.length-1].score),h.localStorGame(u[u.length-1]),h.compileFromHandle(),u.length<3&&l.addClass("disabled"))}},g={initialize:function(){e=Handlebars.compile(d);var t=h.localStorGame();t?(m=t.size,a.attr("data-size",m),f=t.score,o.html(f),v=t.cells,u.push({score:f,cells:jQuery.extend(!0,{},v)}),h.compileFromHandle(v),h.localStorBest()):h.renderNewGrid()},actions:function(){$(document).on("keydown",function(e){switch(e.which){case 37:case 65:h.move("left");break;case 38:case 87:h.move("top");break;case 39:case 68:h.move("right");break;case 40:case 83:h.move("down");break;case 8:}})},undo:function(){l.on("click",function(){h.undo()})},newGame:function(){c.on("click",function(){i.find(".ng-item").removeClass("activate"),i.find('.ng-item[data-size="'+m+'"]').addClass("activate"),i.toggleClass("opened")}),i.on("click",".ng-item",function(){var e=$(this);i.removeClass("opened"),i.find(".ng-item").removeClass("activate"),e.addClass("activate"),a.attr("data-size",e.attr("data-size")),h.renderNewGrid()})}};return{init:function(){for(var e in g)g.hasOwnProperty(e)&&g[e]()}}}();$(function(){GameApp.init()});