var GameApp=function(){var e,a=$(".app"),t=$(".real-cels"),o=$(".js-cur-score"),r=$(".js-last-cur-score"),n=$(".js-best-score"),s=$(".js-last-best-score"),l=$(".js-undo"),i=$(".js-new-game"),c=$(".new-game-line"),m=$("#undo").html(),d=$(".js-hint"),f=4,v=0,u=[],h={},g={getRandomInt:function(e,a){return Math.floor(Math.random()*(a-e+1))+e},fourOrTwo:function(){return g.getRandomInt(0,10)>7?4:2},setScore:function(e){v+=e,parseInt(o.html())<v&&(r.html("+"+(v-parseInt(o.html()))).addClass("moved"),o.html(v),setTimeout(function(){r.removeClass("moved"),s.removeClass("moved")},200)),parseInt(n.html())<v&&(s.html("+"+(v-parseInt(n.html()))).addClass("moved"),n.html(v),g.localStorBest(v))},getFreeCells:function(){for(var e=[],a=0,t=0;t<f;t++)for(var o=0;o<f;o++)0==h[t][o]?e.push(""+[t]+[o]):a+=h[t][o];return e},gameOver:function(){for(var e=0,t=0;t<f&&0==e;t++)for(var o=0;o<f&&0==e;o++)o+1<f&&h[t][o]==h[t][o+1]&&e++,t+1<f&&h[t][o]==h[t+1][o]&&e++;0==e&&(a.addClass("gameover"),localStorage.removeItem("game"))},newRandCell:function(){var e=g.getFreeCells(),a=e[g.getRandomInt(0,e.length-1)],o=a.slice(0,1),r=a.slice(1,2),n=g.fourOrTwo();h[o][r]=n,t.append('<div class="cell" data-x="'+o+'" data-y="'+r+'" data-num="'+n+'"></div>');var s={score:v,cells:h};u.push(jQuery.extend(!0,{},s)),g.localStorGame(s),1==e.length&&g.gameOver(),u.length>2&&l.removeClass("disabled")},localStorBest:function(e){if(e)localStorage.setItem("best"+f,e);else{var a=localStorage.getItem("best"+f);a?n.html(a):n.html(0)}},localStorGame:function(e){if(!e){var a=JSON.parse(localStorage.getItem("game"));return!!a&&a}e.size=f,localStorage.setItem("game",JSON.stringify(e))},chPos:function(e,a){t.find('.cell[data-x="'+e.x+'"][data-y="'+e.y+'"]').attr("data-x",a.x).attr("data-y",a.y)},compare:function(e,a){var o=t.find('.cell[data-x="'+e.x+'"][data-y="'+e.y+'"]'),r=t.find('.cell[data-x="'+a.x+'"][data-y="'+a.y+'"]');o.attr("data-x",a.x).attr("data-y",a.y),g.setScore(a.num),setTimeout(function(){r.attr("data-num",a.num).addClass("compare"),setTimeout(function(){r.removeClass("compare")},100),o.remove()},100)},move:function(e){switch(e){case"up":for(var a=0;a<f;a++)for(var t,o=0;o<f;o++)if(h[a][o])for(var r=o;r>0;)if(h[a][r-1]){if(h[a][r-1]!=h[a][r]||t==""+a+(r-1))break;h[a][r-1]*=2,t=""+a+(r-1),g.compare({x:a,y:r},{x:a,y:r-1,num:h[a][r-1]}),h[a][r]=0}else h[a][r-1]=h[a][r],h[a][r]=0,g.chPos({x:a,y:r},{x:a,y:r-1}),r--;break;case"down":for(var a=0;a<f;a++)for(var t,o=f-1;o>=0;o--)if(h[a][o])for(var r=o;r<f-1;)if(h[a][r+1]){if(h[a][r+1]!=h[a][r]||t==""+a+(r+1))break;h[a][r+1]*=2,t=""+a+(r+1),g.compare({x:a,y:r},{x:a,y:r+1,num:h[a][r+1]}),h[a][r]=0}else h[a][r+1]=h[a][r],h[a][r]=0,g.chPos({x:a,y:r},{x:a,y:r+1}),r++;break;case"left":for(var a=0;a<f;a++)for(var t,o=0;o<f;o++)if(h[a][o])for(var r=a;r>0;)if(h[r-1][o]){if(h[r-1][o]!=h[r][o]||t==""+(r-1)+o)break;h[r-1][o]*=2,t=""+(r-1)+o,g.compare({x:r,y:o},{x:r-1,y:o,num:h[r-1][o]}),h[r][o]=0}else h[r-1][o]=h[r][o],h[r][o]=0,g.chPos({x:r,y:o},{x:r-1,y:o}),r--;break;case"right":for(var a=f-1;a>=0;a--)for(var t,o=0;o<f;o++)if(h[a][o])for(var r=a;r<f-1;)if(h[r+1][o]){if(h[r+1][o]!=h[r][o]||t==""+(r-1)+o)break;h[r+1][o]*=2,t=""+(r-1)+o,g.compare({x:r,y:o},{x:r+1,y:o,num:h[r+1][o]}),h[r][o]=0}else h[r+1][o]=h[r][o],h[r][o]=0,g.chPos({x:r,y:o},{x:r+1,y:o}),r++}g.afterMove()},afterMove:function(){var e=u[u.length-1].cells,a=JSON.stringify(e)===JSON.stringify(h);a||g.newRandCell()},renderNewGrid:function(){f=parseInt(a.attr("data-size")),l.addClass("disabled"),t.html(""),r.removeClass("moved"),s.removeClass("moved"),o.html(0),r.removeClass("moved"),s.removeClass("moved"),u=[],v=0,h={};for(var e=0;e<f;e++){h[e]={};for(var n=0;n<f;n++)h[e][n]=0}g.newRandCell(),g.newRandCell(),g.localStorBest()},compileFromHandle:function(){t.html(e(h))},undo:function(){l.hasClass("disabled")||(a.removeClass("gameover"),u.splice(u.length-1,1),h=jQuery.extend(!0,{},u[u.length-1].cells),v=u[u.length-1].score,o.html(u[u.length-1].score),g.localStorGame(u[u.length-1]),g.compileFromHandle(),u.length<3&&l.addClass("disabled"))},hint:function(){for(var e={0:0,1:0},a=0;a<f;a++)for(var t=0;t<f;t++)if(0!=h[a][t]&&t+1<f&&a+1<f){0!=h[a][t+1];h[a][t]&&(e[0]+=2*h[a][t]),h[a][t]==h[a+1][t]&&(e[1]+=2*h[a][t])}console.log(e)}},p={initialize:function(){e=Handlebars.compile(m);var t=g.localStorGame();t?(f=t.size,a.attr("data-size",f),v=t.score,o.html(v),h=t.cells,u.push({score:v,cells:jQuery.extend(!0,{},h)}),g.compileFromHandle(h),g.localStorBest()):g.renderNewGrid()},actions:function(){$(document).on("keydown",function(e){switch(e.which){case 37:case 65:g.move("left");break;case 38:case 87:g.move("up");break;case 39:case 68:g.move("right");break;case 40:case 83:g.move("down");break;case 8:}}),a.swipe({swipe:function(e,a,t,o,r,n){g.move(a)}})},undo:function(){l.on("click",function(){g.undo()})},newGame:function(){i.on("click",function(){c.find(".ng-item").removeClass("activate"),c.find('.ng-item[data-size="'+f+'"]').addClass("activate"),c.toggleClass("opened")}),c.on("click",".ng-item",function(){var e=$(this);c.removeClass("opened"),c.find(".ng-item").removeClass("activate"),e.addClass("activate"),a.attr("data-size",e.attr("data-size")),g.renderNewGrid()})},hint:function(){d.on("click",function(){g.hint()})}};return{init:function(){for(var e in p)p.hasOwnProperty(e)&&p[e]()}}}();$(function(){GameApp.init()});