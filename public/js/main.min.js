var GameApp=function(){var e,a=$(".app"),t=$(".real-cels"),r=$(".js-cur-score"),o=$(".js-last-cur-score"),n=$(".js-best-score"),s=$(".js-last-best-score"),l=$(".js-undo"),c=$(".js-new-game"),i=$(".new-game-line"),m=$("#undo").html(),d=4,f=0,v=[],u={},h={getRandomInt:function(e,a){return Math.floor(Math.random()*(a-e+1))+e},fourOrTwo:function(){return h.getRandomInt(0,10)>7?4:2},setScore:function(e){f+=e,parseInt(r.html())<f&&(o.html("+"+(f-parseInt(r.html()))).addClass("moved"),r.html(f),setTimeout(function(){o.removeClass("moved"),s.removeClass("moved")},200)),parseInt(n.html())<f&&(s.html("+"+(f-parseInt(n.html()))).addClass("moved"),n.html(f),h.localStorBest(f))},getFreeCells:function(){for(var e=[],a=0,t=0;t<d;t++)for(var r=0;r<d;r++)0==u[t][r]?e.push(""+[t]+[r]):a+=u[t][r];return e},gameOver:function(){for(var e=0,t=0;t<d&&0==e;t++)for(var r=0;r<d&&0==e;r++)r+1<d&&u[t][r]==u[t][r+1]&&e++,t+1<d&&u[t][r]==u[t+1][r]&&e++;0==e&&(a.addClass("gameover"),localStorage.removeItem("game"))},newRandCell:function(){var e=h.getFreeCells(),a=e[h.getRandomInt(0,e.length-1)],r=a.slice(0,1),o=a.slice(1,2),n=h.fourOrTwo();u[r][o]=n,t.append('<div class="cell" data-x="'+r+'" data-y="'+o+'" data-num="'+n+'"></div>');var s={score:f,cells:u};v.push(jQuery.extend(!0,{},s)),h.localStorGame(s),1==e.length&&h.gameOver(),v.length>2&&l.removeClass("disabled")},localStorBest:function(e){if(e)localStorage.setItem("best"+d,e);else{var a=localStorage.getItem("best"+d);a?n.html(a):n.html(0)}},localStorGame:function(e){if(!e){var a=JSON.parse(localStorage.getItem("game"));return!!a&&a}e.size=d,localStorage.setItem("game",JSON.stringify(e))},chPos:function(e,a){t.find('.cell[data-x="'+e.x+'"][data-y="'+e.y+'"]').attr("data-x",a.x).attr("data-y",a.y)},compare:function(e,a){var r=t.find('.cell[data-x="'+e.x+'"][data-y="'+e.y+'"]'),o=t.find('.cell[data-x="'+a.x+'"][data-y="'+a.y+'"]');r.attr("data-x",a.x).attr("data-y",a.y),h.setScore(a.num),setTimeout(function(){o.attr("data-num",a.num).addClass("compare"),setTimeout(function(){o.removeClass("compare")},100),r.remove()},100)},move:function(e){switch(e){case"up":for(var a=0;a<d;a++)for(var t,r=0;r<d;r++)if(u[a][r])for(var o=r;o>0;)if(u[a][o-1]){if(u[a][o-1]!=u[a][o]||t==""+a+(o-1))break;u[a][o-1]*=2,t=""+a+(o-1),h.compare({x:a,y:o},{x:a,y:o-1,num:u[a][o-1]}),u[a][o]=0}else u[a][o-1]=u[a][o],u[a][o]=0,h.chPos({x:a,y:o},{x:a,y:o-1}),o--;break;case"down":for(var a=0;a<d;a++)for(var t,r=d-1;r>=0;r--)if(u[a][r])for(var o=r;o<d-1;)if(u[a][o+1]){if(u[a][o+1]!=u[a][o]||t==""+a+(o+1))break;u[a][o+1]*=2,t=""+a+(o+1),h.compare({x:a,y:o},{x:a,y:o+1,num:u[a][o+1]}),u[a][o]=0}else u[a][o+1]=u[a][o],u[a][o]=0,h.chPos({x:a,y:o},{x:a,y:o+1}),o++;break;case"left":for(var a=0;a<d;a++)for(var t,r=0;r<d;r++)if(u[a][r])for(var o=a;o>0;)if(u[o-1][r]){if(u[o-1][r]!=u[o][r]||t==""+(o-1)+r)break;u[o-1][r]*=2,t=""+(o-1)+r,h.compare({x:o,y:r},{x:o-1,y:r,num:u[o-1][r]}),u[o][r]=0}else u[o-1][r]=u[o][r],u[o][r]=0,h.chPos({x:o,y:r},{x:o-1,y:r}),o--;break;case"right":for(var a=d-1;a>=0;a--)for(var t,r=0;r<d;r++)if(u[a][r])for(var o=a;o<d-1;)if(u[o+1][r]){if(u[o+1][r]!=u[o][r]||t==""+(o-1)+r)break;u[o+1][r]*=2,t=""+(o-1)+r,h.compare({x:o,y:r},{x:o+1,y:r,num:u[o+1][r]}),u[o][r]=0}else u[o+1][r]=u[o][r],u[o][r]=0,h.chPos({x:o,y:r},{x:o+1,y:r}),o++}h.afterMove()},afterMove:function(){var e=v[v.length-1].cells,a=JSON.stringify(e)===JSON.stringify(u);a||h.newRandCell()},renderNewGrid:function(){d=parseInt(a.attr("data-size")),l.addClass("disabled"),t.html(""),o.removeClass("moved"),s.removeClass("moved"),r.html(0),o.removeClass("moved"),s.removeClass("moved"),v=[],f=0,u={};for(var e=0;e<d;e++){u[e]={};for(var n=0;n<d;n++)u[e][n]=0}h.newRandCell(),h.newRandCell(),h.localStorBest()},compileFromHandle:function(){t.html(e(u))},undo:function(){l.hasClass("disabled")||(a.removeClass("gameover"),v.splice(v.length-1,1),u=jQuery.extend(!0,{},v[v.length-1].cells),f=v[v.length-1].score,r.html(v[v.length-1].score),h.localStorGame(v[v.length-1]),h.compileFromHandle(),v.length<3&&l.addClass("disabled"))}},g={initialize:function(){e=Handlebars.compile(m);var t=h.localStorGame();t?(d=t.size,a.attr("data-size",d),f=t.score,r.html(f),u=t.cells,v.push({score:f,cells:jQuery.extend(!0,{},u)}),h.compileFromHandle(u),h.localStorBest()):h.renderNewGrid()},actions:function(){$(document).on("keydown",function(e){switch(e.which){case 37:case 65:h.move("left");break;case 38:case 87:h.move("up");break;case 39:case 68:h.move("right");break;case 40:case 83:h.move("down");break;case 8:}}),a.swipe({swipe:function(e,a,t,r,o,n){h.move(a)}})},undo:function(){l.on("click",function(){h.undo()})},newGame:function(){c.on("click",function(){i.find(".ng-item").removeClass("activate"),i.find('.ng-item[data-size="'+d+'"]').addClass("activate"),i.toggleClass("opened")}),i.on("click",".ng-item",function(){var e=$(this);i.removeClass("opened"),i.find(".ng-item").removeClass("activate"),e.addClass("activate"),a.attr("data-size",e.attr("data-size")),h.renderNewGrid()})}};return{init:function(){for(var e in g)g.hasOwnProperty(e)&&g[e]()}}}();$(function(){GameApp.init()});
